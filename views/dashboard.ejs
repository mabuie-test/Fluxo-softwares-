<%- include('partials/head') %>
<%- include('partials/header') %>
    <main class="section dashboard">
      <div class="container">
        <div class="dashboard-header">
          <div>
            <span class="eyebrow">Olá, <%= currentUser.name %></span>
            <h1>
              <% if (isAdmin) { %>
              Acompanhe e evolua as solicitações da Fluxo Softwares.
              <% } else { %>
              Gerencie as suas solicitações e acompanhe cada etapa.
              <% } %>
            </h1>
          </div>
          <% if (!isAdmin) { %>
          <a class="button button-outline" href="/contacto">Abrir um novo projecto estratégico</a>
          <% } %>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <p>Total</p>
            <strong><%= totals.total %></strong>
          </div>
          <div class="stat-card">
            <p>Novas</p>
            <strong><%= totals.new %></strong>
          </div>
          <div class="stat-card">
            <p>Em análise</p>
            <strong><%= totals.inAnalysis %></strong>
          </div>
          <div class="stat-card">
            <p>Em progresso</p>
            <strong><%= totals.inProgress %></strong>
          </div>
          <div class="stat-card">
            <p>Concluídas</p>
            <strong><%= totals.completed %></strong>
          </div>
        </div>

        <div class="dashboard-columns">
          <section class="dashboard-form">
            <% if (isAdmin) { %>
            <h2>Gestão administrativa</h2>
            <p>
              Utilize o painel ao lado para actualizar o estado de cada solicitação e mantenha a equipa alinhada ao
              progresso real dos projectos.
            </p>
            <% if (adminStatusFlash) { %>
            <div class="alert <%= adminStatusFlash.type === 'success' ? 'alert-success' : 'alert-error' %>">
              <%= adminStatusFlash.message %>
            </div>
            <% } %>
            <div class="admin-tips">
              <h3>Fluxo recomendado</h3>
              <ul>
                <li><strong>Novo</strong> — entrada inicial aguardando triagem.</li>
                <li><strong>Em análise</strong> — requisitos a serem afinados com o cliente.</li>
                <li><strong>Em progresso</strong> — execução em curso pela equipa técnica.</li>
                <li><strong>Concluído</strong> — projecto finalizado e entregue.</li>
              </ul>
            </div>
            <% } else { %>
            <h2>Novo pedido</h2>
            <p>Descreva a sua necessidade para activarmos o time ideal.</p>
            <% if (success) { %>
            <div class="alert alert-success">Solicitação enviada com sucesso! Iremos contactá-lo em breve.</div>
            <% } %>
            <% if (errors.length) { %>
            <div class="alert alert-error">
              <ul>
                <% errors.forEach((error) => { %>
                <li><%= error.msg %></li>
                <% }) %>
              </ul>
            </div>
            <% } %>
            <form action="/solicitacoes" method="post" class="form">
              <div class="form-group">
                <label for="serviceInterest">Tipo de projecto</label>
                <select id="serviceInterest" name="serviceInterest" required>
                  <option value="">Seleccione</option>
                  <option value="marketing" <%= formData.serviceInterest === 'marketing' ? 'selected' : '' %>>Campanha de marketing</option>
                  <option value="web" <%= formData.serviceInterest === 'web' ? 'selected' : '' %>>Website ou sistema web</option>
                  <option value="app" <%= formData.serviceInterest === 'app' ? 'selected' : '' %>>Aplicação Android</option>
                  <option value="iot" <%= formData.serviceInterest === 'iot' ? 'selected' : '' %>>IoT / Electrónica</option>
                  <option value="seguranca" <%= formData.serviceInterest === 'seguranca' ? 'selected' : '' %>>Segurança electrónica</option>
                  <option value="consultoria" <%= formData.serviceInterest === 'consultoria' ? 'selected' : '' %>>Consultoria</option>
                  <option value="outro" <%= formData.serviceInterest === 'outro' ? 'selected' : '' %>>Outro</option>
                </select>
              </div>
              <div class="form-group">
                <label for="details">Detalhes</label>
                <textarea id="details" name="details" rows="4" required><%= formData.details || '' %></textarea>
              </div>
              <div class="form-group">
                <label for="phone">Telefone para contacto</label>
                <input type="text" id="phone" name="phone" value="<%= formData.phone || '' %>" />
              </div>
              <button type="submit" class="button button-primary">Enviar solicitação</button>
            </form>
            <% } %>
          </section>
          <section class="dashboard-list">
            <h2>Histórico de solicitações</h2>
            <% if (!requests.length) { %>
            <p class="empty-state">Ainda não existem solicitações. Crie a primeira para começarmos!</p>
            <% } else { %>
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <% if (isAdmin) { %>
                    <th>Cliente</th>
                    <% } %>
                    <th>Tipo</th>
                    <th>Detalhes</th>
                    <th>Status</th>
                    <th>Enviado em</th>
                    <% if (isAdmin) { %>
                    <th>Acções</th>
                    <% } %>
                  </tr>
                </thead>
                <tbody>
                  <% requests.forEach((request) => { %>
                  <tr>
                    <% if (isAdmin) { %>
                    <td class="request-origin">
                      <strong><%= request.client ? request.client.name : request.contactName %></strong>
                      <span><%= request.client ? request.client.email : request.contactEmail %></span>
                    </td>
                    <% } %>
                    <td><%= request.serviceInterest %></td>
                    <td><%= request.details %></td>
                    <td><span class="status-pill status-<%= request.status.toLowerCase().replace(' ', '-') %>"><%= request.status %></span></td>
                    <td><%= new Date(request.createdAt).toLocaleDateString('pt-PT') %></td>
                    <% if (isAdmin) { %>
                    <td>
                      <form action="/solicitacoes/<%= request.id %>/status" method="post" class="admin-status-form">
                        <label class="sr-only" for="status-<%= request.id %>">Actualizar estado</label>
                        <select id="status-<%= request.id %>" name="status" class="status-select">
                          <% statusOptions.forEach((option) => { %>
                          <option value="<%= option %>" <%= request.status === option ? 'selected' : '' %>><%= option %></option>
                          <% }) %>
                        </select>
                        <button type="submit" class="button button-secondary button-compact">Actualizar</button>
                      </form>
                    </td>
                    <% } %>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </section>
        </div>
      </div>
    </main>
<%- include('partials/footer') %>
